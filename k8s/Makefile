# Makefile para gestiÃ³n de cluster local con Kind/Minikube y charts de Helm
# Requiere: kind/minikube, kubectl, helm, docker

CLUSTER_NAME := local-k8s
KUBECONFIG_PATH := ~/.kube/config
PROVIDER := $(or $(PROVIDER),kind)

.PHONY: help init deploy clean destroy kiali kafka-ui mqtt rabbitmq kafka-rabbitmq-replicator kafka-rabbitmq-replicator-logs kafka-rabbitmq-replicator-status create-kafka-topics wait-for-kafka create-topic-if-not-exists create-rabbitmq-resources wait-for-rabbitmq

help: ## Mostrar ayuda
	@echo "Comandos disponibles:"
	@echo "  init PROVIDER=kind     - Crear cluster local con Kind (default)"
	@echo "  init PROVIDER=minikube - Crear cluster local con Minikube"
	@echo "  deploy                 - Desplegar toda la arquitectura EDA completa"
	@echo "  status                 - Mostrar estado de todos los componentes"
	@echo "  kiali                  - Abrir Kiali dashboard (requiere Istio)"
	@echo "  kafka-ui               - Abrir Kafka UI dashboard"
	@echo ""
	@echo "  mqtt                   - Abrir EMQX dashboard"
	@echo "  rabbitmq               - Abrir RabbitMQ Management UI"
	@echo "  order-gateway          - Configurar Istio Gateway para Order Service"
	@echo "  clean                  - Eliminar charts del cluster"
	@echo "  destroy                - Eliminar cluster completamente"
	@echo ""
	@echo "ğŸ”„ Arquitectura desplegada:"
	@echo "  Flujo Principal: MQTT â†’ Kafka (Principal)"
	@echo "  Cluster Adicional: Kafka Warehouse"
	@echo "  ReplicaciÃ³n Bidireccional:"
	@echo "    â€¢ damage, events-sensor â†’ Kafka Principal â†’ Kafka Warehouse"
	@echo "    â€¢ warehouse-events, inventory-updates â† Kafka Principal â† Kafka Warehouse"
	@echo ""
	@echo "Ejemplos:"
	@echo "  make init              # Usa Kind por defecto"
	@echo "  make deploy            # Despliega arquitectura completa"
	@echo "  make status            # Ver estado de componentes"
	@echo "  make kafka-ui          # Abrir Kafka UI dashboard"
	@echo "  make mqtt              # Abrir EMQX dashboard"
	@echo "  make rabbitmq          # Abrir RabbitMQ Management UI"
	@echo "  make create-kafka-topics # Crear topics necesarios para replicaciÃ³n"
	@echo "  make create-rabbitmq-resources # Crear queues y exchanges de RabbitMQ"
	@echo "  kafka-rabbitmq-replicator-logs   # Ver logs del replicador Kafka-RabbitMQ"
	@echo "  kafka-rabbitmq-replicator-status # Estado del replicador Kafka-RabbitMQ"

init: ## Crear cluster local con Kind o Minikube
	@echo "ğŸš€ Creando cluster local con $(PROVIDER)..."
ifeq ($(PROVIDER),kind)
	@if kind get clusters | grep -q $(CLUSTER_NAME); then \
		echo "âš ï¸  El cluster $(CLUSTER_NAME) ya existe"; \
	else \
		kind create cluster --name $(CLUSTER_NAME) --config=config/kind-config.yaml; \
	fi
	@echo "âœ… Configurando kubectl context..."
	@kubectl config use-context kind-$(CLUSTER_NAME)
else ifeq ($(PROVIDER),minikube)
	@if minikube status -p $(CLUSTER_NAME) >/dev/null 2>&1; then \
		echo "âš ï¸  El cluster $(CLUSTER_NAME) ya existe"; \
	else \
		minikube start -p $(CLUSTER_NAME) \
			--driver=docker \
			--cpus=2 \
			--memory=6144 \
			--disk-size=20g \
			--kubernetes-version=stable \
			--addons=ingress,dashboard,metrics-server; \
	fi
	@echo "âœ… Configurando kubectl context..."
	@kubectl config use-context $(CLUSTER_NAME)
else
	@echo "âŒ PROVIDER debe ser 'kind' o 'minikube'"
	@exit 1
endif
	@echo "ğŸ‰ Cluster $(CLUSTER_NAME) con $(PROVIDER) listo!"

ifeq ($(PROVIDER),kind)
	@echo "ğŸ”¨ Construyendo y cargando imÃ¡genes Docker en Kind..."
	@$(MAKE) -C ../services build-load-all
endif

	@echo "ğŸ“¦ Desplegando charts en el cluster..."
	@echo "ğŸ”§ Verificando que el cluster estÃ© activo..."
ifeq ($(PROVIDER),kind)
	@kubectl cluster-info --context kind-$(CLUSTER_NAME) > /dev/null
else
	@kubectl cluster-info --context $(CLUSTER_NAME) > /dev/null
endif
	
	@echo "ğŸ“‹ Agregando repositorios de Helm..."
#	@helm repo add istio https://istio-release.storage.googleapis.com/charts || true
#	@helm repo add kedacore https://kedacore.github.io/charts || true
#	@helm repo update
	
	@echo "ğŸš€ Desplegando Istio Base..."
	@helm upgrade --install istio-base ./istio/base \
		--namespace istio-system \
		--set defaultRevision=default \
		--create-namespace \
		--wait
	
	@echo "ğŸ”§ Desplegando Istiod..."
	@helm upgrade --install istiod ./istio/istiod \
		--namespace istio-system \
		--wait

	@echo "ğŸ“¦ AddOns no estÃ¡ instalado. Instalando AddOns..."; \
		kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.27/samples/addons/prometheus.yaml; \
		kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.27/samples/addons/jaeger.yaml; \
		kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.27/samples/addons/grafana.yaml; \
		kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.27/samples/addons/kiali.yaml; \
		echo "â³ Esperando a que AddOns estÃ© listo..."; \
		kubectl wait --for=condition=available --timeout=300s deployment/prometheus -n istio-system; \
		kubectl wait --for=condition=available --timeout=300s deployment/jaeger -n istio-system; \
		kubectl wait --for=condition=available --timeout=300s deployment/grafana -n istio-system; \
		kubectl wait --for=condition=available --timeout=300s deployment/kiali -n istio-system; \

	@echo "ğŸŒ Desplegando Istio Gateway..."
#	@helm upgrade --install istio-gateway ./istio/gateway \
		--namespace istio-system \
		--set profile=demo \
		--wait
	
	@echo "âš¡ Desplegando KEDA..."
	@helm upgrade --install keda ./keda \
		--namespace keda-system \
		--create-namespace \
		--wait
	
	@echo "âœ… Todos los charts desplegados exitosamente!"

deploy:
	@kubectl create namespace medisupply --dry-run=client -o yaml | kubectl apply -f - || echo "âœ… Namespace medisupply ya existe o fue creado"
	@kubectl label namespace medisupply istio-injection=enabled

	@kubectl create namespace medilogistic --dry-run=client -o yaml | kubectl apply -f - || echo "âœ… Namespace medilogistic ya existe o fue creado"
	@kubectl label namespace medilogistic istio-injection=enabled

	@kubectl create namespace mediorder --dry-run=client -o yaml | kubectl apply -f - || echo "âœ… Namespace mediorder ya existe o fue creado"
	@kubectl label namespace mediorder istio-injection=enabled

	@kubectl create namespace mediwarehouse --dry-run=client -o yaml | kubectl apply -f - || echo "âœ… Namespace mediwarehouse ya existe o fue creado"
	@kubectl label namespace mediwarehouse istio-injection=enabled

    # Medisupply - Main
	@echo "âš¡ Desplegando Kafka (cluster principal)..."
	@helm upgrade --install kafka ./kafka \
		--namespace medisupply \
		--values ./config/kafka-values.yaml \
		--wait

	@echo "ğŸ–¥ï¸  Desplegando Kafka UI (ambos clusters)..."
	@helm upgrade --install kafka-ui ./kafka-ui \
		--namespace medisupply \
		--wait
	
	@echo "ğŸ“¡ Desplegando MQTT (EMQX)..."
	@helm upgrade --install emqx ./mqtt/emqx \
		--namespace medilogistic \
		--wait

	@echo "ğŸ”— Desplegando MQTT-Kafka Bridge..."
	@helm upgrade --install mqtt-kafka-bridge ./mqtt-kafka-bridge \
		--namespace medisupply \
		--wait

	@echo "âš¡ Desplegando Kafka Warehouse (cluster secundario)..."
	@helm upgrade --install kafka-warehouse ./kafka \
		--namespace mediwarehouse \
		--values ./config/kafka-warehouse-values.yaml \
		--wait

	@echo "ï¿½ Creando topics necesarios para replicaciÃ³n..."
	@$(MAKE) create-kafka-topics

	@echo "ğŸ”„ Desplegando Kafka-Kafka Replicator (replicaciÃ³n bidireccional)..."
	@helm upgrade --install kafka-replicator ./kafka-replicator \
		--namespace medisupply \
		--wait --timeout 10m

	@echo "ğŸ° Desplegando RabbitMQ..."
	@helm upgrade --install rabbitmq ./rabbitmq \
		--namespace mediorder \
		--wait

	@echo "ğŸ° Copiar secreto de mediorder a medisupply"
	@if kubectl get secret rabbitmq -n medisupply >/dev/null 2>&1; then \
		echo "ğŸ”„ Secreto rabbitmq ya existe en medisupply, eliminando y recreando..."; \
		kubectl delete secret rabbitmq -n medisupply; \
		kubectl get secret rabbitmq -n mediorder -o yaml | \
		sed 's/namespace: mediorder/namespace: medisupply/' | \
		kubectl create -f -; \
	else \
		echo "ğŸ“‹ Creando secreto rabbitmq en medisupply..."; \
		kubectl get secret rabbitmq -n mediorder -o yaml | \
		sed 's/namespace: mediorder/namespace: medisupply/' | \
		kubectl create -f -; \
	fi

	@echo "ï¿½ Cereando recursos de RabbitMQ necesarios para replicaciÃ³n..."
	@$(MAKE) create-rabbitmq-resources
	
	@echo "ğŸ”„ Desplegando Kafka-RabbitMQ Replicator (replicaciÃ³n bidireccional)..."
	@helm upgrade --install kafka-rabbitmq-replicator ./kafka-rabbitmq-replicator \
		--namespace medisupply \
		--wait

    # Logistic
	@echo "ğŸ“Š Desplegando MQTT Event Generator..."
	@helm upgrade --install mqtt-event-generator ./microservice \
		--namespace medilogistic \
		--values ./config/services/mqtt-event-generator-values.yaml \
		--wait

	@echo "ğŸ“Š Desplegando MQTT Order Event Client..."
	@helm upgrade --install mqtt-order-event-client ./microservice \
		--namespace medilogistic \
		--values ./config/services/mqtt-order-event-client-values.yaml \
		--wait

    # Order
	@echo "ğŸ“¦ Desplegando Order Management Service..."
	@helm upgrade --install order-service ./microservice \
		--namespace mediorder \
		--values ./config/services/order_management/order/order-service-values.yaml \
		--wait

    # Warehouse
	@echo "ğŸ“¦ Desplegando Warehouse Batch..."
	@helm upgrade --install warehouse-batch ./microservice \
		--namespace mediwarehouse \
		--values ./config/services/warehouse/batch/batch-service-values.yaml \
		--wait

	@echo "ğŸ”¨ Autoscalling - KEDA..."
	@$(MAKE) -C keda-scaling install
    
	@echo ""
	@echo "ğŸ‰ Â¡Despliegue completado exitosamente!"
	@echo "ğŸ“‹ Servicios desplegados:"
	@echo "  âœ… Kafka (Principal) + Kafka Warehouse + Kafka UI"
	@echo "  âœ… Topics de Kafka creados automÃ¡ticamente"
	@echo "  âœ… EMQX (MQTT Broker)"
	@echo "  âœ… RabbitMQ + Queues y Exchanges creados automÃ¡ticamente"
	@echo "  âœ… Order Management Service"
	@echo "  âœ… MQTT Event Generator"
	@echo "  âœ… MQTT Order Event Client"
	@echo "  âœ… Warehouse Batch"
	@echo "  âœ… MQTT-Kafka Bridge"
	@echo "  âœ… Kafka Replicator (ReplicaciÃ³n Bidireccional)"
	@echo "  âœ… Kafka-RabbitMQ Replicator (ReplicaciÃ³n Bidireccional)"
	@echo "  âœ… Strimzi Operator"
	@echo "  âœ… Kafka Pedidos (Cluster secundario)"
	@echo "  âœ… Kafka Connect + RabbitMQ Connector"
	@echo "  âœ… Kafka Replicator (Python-based)"
	@echo ""
	@echo ""
	@echo "ğŸ”„ Flujos de datos configurados:"
	@echo "  ğŸ“¡ MQTT â†’ Kafka:"
	@echo "     mqtt-event-generator â†’ EMQX â†’ mqtt-order-event-client â†’ EMQX â†’ mqtt-kafka-bridge â†’ Kafka"
	@echo "  ğŸ”„ ReplicaciÃ³n Bidireccional (Kafka Replicator):"
	@echo "     Kafka âŸ· Kafka Warehouse"
	@echo "     â€¢ events-order-damage â†’ warehouse-order-damage"
	@echo "     â€¢ events-sensor â†’ warehouse-sensor"
	@echo "     â€¢ order-events â†’ order-events"
	@echo "  ğŸ”„ ReplicaciÃ³n Bidireccional (Kafka-RabbitMQ Replicator):"
	@echo "     Kafka âŸ· RabbitMQ"
	@echo "     â€¢ events-order-damage â†’ events exchange â†’ order-damage-queue"
	@echo "     â€¢ order-events-queue â†’ order-events topic"
	@echo ""
	@echo "ğŸ’¡ Para acceder a los dashboards:"
	@echo "  make kafka-ui    # Kafka UI (ambos clusters) en http://localhost:9090"
	@echo "  make mqtt        # EMQX en http://localhost:18083"
	@echo "  make rabbitmq    # RabbitMQ en http://localhost:15672"
	@echo ""

clean: ## Eliminar charts del cluster
	@echo "ğŸ§¹ Eliminando charts del cluster..."
	@echo ""
    # Logistic
	@echo "ğŸ“Š Eliminando MQTT Event Generator..."
	@helm uninstall mqtt-event-generator --namespace medilogistic || true
	@echo "ğŸ“Š Eliminando MQTT Order Event Client..."
	@helm uninstall mqtt-order-event-client --namespace medilogistic || true
	@echo "ğŸ“¡ Eliminando EMQX..."
	@helm uninstall emqx --namespace medilogistic || true

    # Order
	@echo "ï¿½ Eliminnando Order Management Service..."
	@helm uninstall order-service --namespace mediorder || true
	@echo "ğŸ° Eliminando RabbitMQ..."
	@helm uninstall rabbitmq --namespace mediorder || true

    # Warehouse
	@helm uninstall kafka-warehouse --namespace mediwarehouse || true
	@echo "âš¡ Eliminando Kafka..."
	@echo "ğŸ“Š Eliminando Warehouse Batch..."
	@helm uninstall warehouse-batch --namespace mediwarehouse || true

    # MediSupply
	@echo "ğŸ”„ Eliminando Kafka Replicator..."
	@helm uninstall kafka-replicator --namespace medisupply || true
	@echo "ğŸ”„ Eliminando Kafka-RabbitMQ Replicator..."
	@helm uninstall kafka-rabbitmq-replicator --namespace medisupply || true
	@echo "ğŸ”— Eliminando MQTT-Kafka Bridge..."
	@helm uninstall mqtt-kafka-bridge --namespace medisupply || true
	@echo "ğŸ–¥ï¸  Eliminando Kafka UI..."
	@helm uninstall kafka-ui --namespace medisupply || true
	@echo "âš¡ Eliminando Kafka Warehouse..."
	@helm uninstall kafka --namespace medisupply || true
	@echo ""
	@echo "ğŸ—‘ï¸  Eliminando namespace medisupply..."
	@kubectl delete namespace medisupply --ignore-not-found=true
	@kubectl delete namespace medilogistic --ignore-not-found=true
	@kubectl delete namespace mediorder --ignore-not-found=true
	@kubectl delete namespace mediwarehouse --ignore-not-found=true
	@echo ""
	@echo "âœ… Todos los charts eliminados del cluster!"
	@echo "ğŸ“‹ Servicios eliminados:"
	@echo "  âŒ Warehouse Batch"
	@echo "  âŒ MQTT Event Generator"
	@echo "  âŒ MQTT Order Event Client"
	@echo "  âŒ MQTT-Kafka Bridge"
	@echo "  âŒ Order Management Service"
	@echo "  âŒ RabbitMQ"
	@echo "  âŒ EMQX (MQTT Broker)"
	@echo "  âŒ Kafka UI"
	@echo "  âŒ Kafka"
	@echo "  âŒ Kafka Pedidos"
	@echo "  âŒ Kafka Connect + Conectores"
	@echo "  âŒ Kafka Replicator"
	@echo "  âŒ Kafka-RabbitMQ Replicator"
	@echo "  âŒ Strimzi Operator"
	@echo "  âŒ Namespace medisupply"
	@echo "  âŒ Namespace medilogistic"
	@echo "  âŒ Namespace mediorder"
	@echo "  âŒ Namespace mediwarehouse"

destroy: ## Eliminar cluster completamente
	@echo "ğŸ’¥ Eliminando cluster $(CLUSTER_NAME)..."
ifeq ($(PROVIDER),kind)
	@if kind get clusters | grep -q $(CLUSTER_NAME); then \
		kind delete cluster --name $(CLUSTER_NAME); \
		echo "âœ… Cluster $(CLUSTER_NAME) eliminado completamente!"; \
	else \
		echo "âš ï¸  El cluster $(CLUSTER_NAME) no existe"; \
	fi
else ifeq ($(PROVIDER),minikube)
	@if minikube status -p $(CLUSTER_NAME) >/dev/null 2>&1; then \
		minikube delete -p $(CLUSTER_NAME); \
		echo "âœ… Cluster $(CLUSTER_NAME) eliminado completamente!"; \
	else \
		echo "âš ï¸  El cluster $(CLUSTER_NAME) no existe"; \
	fi
else
	@echo "âŒ PROVIDER debe ser 'kind' o 'minikube'"
	@exit 1
endif

rabbitmq: ## Abrir RabbitMQ Management UI
	@echo "ğŸ° Abriendo RabbitMQ Management UI..."
	@echo "ğŸ“¡ Configurando port-forward para RabbitMQ..."
	@kubectl port-forward -n mediorder svc/rabbitmq 15672:15672 &
	@sleep 3
	@echo "ğŸŒ RabbitMQ Management UI disponible en: http://localhost:15672"
	@echo "ğŸ’¡ Usuario: user, ContraseÃ±a: $(shell kubectl get secret --namespace medisupply rabbitmq -o jsonpath="{.data.rabbitmq-password}" | base64 -d)"
	@echo "ğŸ’¡ Presiona Ctrl+C para detener el port-forward"

mqtt: ## Abrir EMQX dashboard
	@echo "ğŸ“¡ Abriendo EMQX dashboard..."
	@echo "ğŸ“¡ Configurando port-forward para EMQX..."
	@kubectl port-forward -n medilogistic svc/emqx 18083:18083 &
	@sleep 3
	@echo "ğŸŒ EMQX disponible en: http://localhost:18083"
	@echo "ğŸ’¡ Usuario: admin, ContraseÃ±a: public"
	@echo "ğŸ’¡ Presiona Ctrl+C para detener el port-forward"

kafka-ui: ## Abrir Kafka UI dashboard
	@echo "ğŸ–¥ï¸  Abriendo Kafka UI dashboard..."
	@echo "ğŸ“¡ Configurando port-forward para Kafka UI..."
	@kubectl port-forward -n medisupply svc/kafka-ui 9090:8080 &
	@sleep 3
	@echo "ğŸŒ Kafka UI disponible en: http://localhost:9090"
	@echo "ğŸ’¡ Presiona Ctrl+C para detener el port-forward"

kiali: ## Abrir Kiali dashboard
	@echo "ğŸ” Abriendo Kiali dashboard..."
	@echo "ğŸ“¡ Configurando port-forward para Kiali..."
	@kubectl port-forward -n istio-system svc/kiali 20001:20001 &
	@sleep 3
	@echo "ğŸŒ Kiali disponible en: http://localhost:20001"
	@echo "ğŸ’¡ Presiona Ctrl+C para detener el port-forward"

status: ## Mostrar estado de todos los componentes
	@echo "ğŸ“Š Estado de los componentes del sistema:"
	@echo ""
	@echo "ğŸ” Pods en namespace medisupply:"
	@kubectl get pods -n medisupply -o wide || echo "âŒ Error obteniendo pods"
	@echo ""
	@echo "ğŸ” Pods en namespace medilogictic:"
	@kubectl get pods -n medilogistic -o wide || echo "âŒ Error obteniendo pods"
	@echo ""
	@echo "ğŸ” Pods en namespace mediorder:"
	@kubectl get pods -n mediorder -o wide || echo "âŒ Error obteniendo pods"
	@echo ""
	@echo "ğŸ” Pods en namespace mediwarehouse:"
	@kubectl get pods -n mediwarehouse -o wide || echo "âŒ Error obteniendo pods"
	@echo ""
	@echo "ğŸ” Servicios medisupply:"
	@kubectl get svc -n medisupply || echo "âŒ Error obteniendo servicios"
	@echo ""
	@echo "ğŸ” Servicios medilogistic:"
	@kubectl get svc -n medilogistic || echo "âŒ Error obteniendo servicios"
	@echo ""
	@echo "ğŸ” Servicios mediorder:"
	@kubectl get svc -n mediorder || echo "âŒ Error obteniendo servicios"
	@echo ""
	@echo "ğŸ” Servicios mediwarehouse:"
	@kubectl get svc -n mediwarehouse || echo "âŒ Error obteniendo servicios"

wait-for-kafka: ## Esperar a que Kafka estÃ© disponible
	@echo "â³ Esperando a que Kafka Principal estÃ© listo..."
	@for i in $$(seq 1 30); do \
		if kubectl exec -n medisupply kafka-controller-0 -- kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1; then \
			echo "âœ… Kafka Principal estÃ¡ listo"; \
			break; \
		else \
			echo "â³ Esperando Kafka Principal (intento $$i/30)..."; \
			sleep 10; \
		fi; \
		if [ $$i -eq 30 ]; then \
			echo "âŒ Timeout esperando Kafka Principal"; \
			exit 1; \
		fi; \
	done
	
	@echo "â³ Esperando a que Kafka Warehouse estÃ© listo..."
	@for i in $$(seq 1 30); do \
		if kubectl exec -n mediwarehouse kafka-warehouse-controller-0 -- kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1; then \
			echo "âœ… Kafka Warehouse estÃ¡ listo"; \
			break; \
		else \
			echo "â³ Esperando Kafka Warehouse (intento $$i/30)..."; \
			sleep 10; \
		fi; \
		if [ $$i -eq 30 ]; then \
			echo "âŒ Timeout esperando Kafka Warehouse"; \
			exit 1; \
		fi; \
	done

create-topic-if-not-exists: ## Crear topic si no existe (requiere KAFKA_POD, NAMESPACE, TOPIC_NAME)
	@echo "ğŸ“‹ Verificando topic $(TOPIC_NAME) en $(KAFKA_POD)..."
	@if kubectl exec -n $(NAMESPACE) $(KAFKA_POD) -- kafka-topics.sh \
		--bootstrap-server localhost:9092 \
		--list | grep -q "^$(TOPIC_NAME)$$"; then \
		echo "âœ… Topic $(TOPIC_NAME) ya existe"; \
	else \
		echo "ğŸ“ Creando topic $(TOPIC_NAME)..."; \
		kubectl exec -n $(NAMESPACE) $(KAFKA_POD) -- kafka-topics.sh \
			--bootstrap-server localhost:9092 \
			--create \
			--topic $(TOPIC_NAME) \
			--partitions 1 \
			--replication-factor 1 \
			--config retention.ms=604800000 \
			--config cleanup.policy=delete; \
		echo "âœ… Topic $(TOPIC_NAME) creado exitosamente"; \
	fi

create-kafka-topics: wait-for-kafka ## Crear todos los topics necesarios para replicaciÃ³n
	@echo "ğŸ“‹ Creando topics necesarios para replicaciÃ³n..."
	@echo ""
	
	@echo "ğŸ”¹ Creando topics en Kafka Principal (medisupply)..."
	@$(MAKE) create-topic-if-not-exists KAFKA_POD=kafka-controller-0 NAMESPACE=medisupply TOPIC_NAME=events-order-damage
	@$(MAKE) create-topic-if-not-exists KAFKA_POD=kafka-controller-0 NAMESPACE=medisupply TOPIC_NAME=events-sensor
	@$(MAKE) create-topic-if-not-exists KAFKA_POD=kafka-controller-0 NAMESPACE=medisupply TOPIC_NAME=order-events
	
	@echo ""
	@echo "ğŸ”¹ Creando topics en Kafka Warehouse (mediwarehouse)..."
	@$(MAKE) create-topic-if-not-exists KAFKA_POD=kafka-warehouse-controller-0 NAMESPACE=mediwarehouse TOPIC_NAME=warehouse-order-events
	@$(MAKE) create-topic-if-not-exists KAFKA_POD=kafka-warehouse-controller-0 NAMESPACE=mediwarehouse TOPIC_NAME=warehouse-batch-events
	
	@echo ""
	@echo "âœ… Todos los topics creados exitosamente!"
	@echo "ğŸ“‹ Topics creados:"
	@echo "  ğŸ”¸ Kafka Principal:"
	@echo "    â€¢ events-order-damage"
	@echo "    â€¢ events-sensor" 
	@echo "    â€¢ order-events"
	@echo "  ğŸ”¸ Kafka Warehouse:"
	@echo "    â€¢ warehouse-order-damage"
	@echo "    â€¢ warehouse-sensor"
	@echo "    â€¢ order-events"

wait-for-rabbitmq: ## Esperar a que RabbitMQ estÃ© disponible
	@echo "â³ Esperando a que RabbitMQ estÃ© listo..."
	@for i in $$(seq 1 30); do \
		if kubectl exec -n mediorder rabbitmq-0 -- rabbitmqctl status >/dev/null 2>&1; then \
			echo "âœ… RabbitMQ estÃ¡ listo"; \
			break; \
		else \
			echo "â³ Esperando RabbitMQ (intento $$i/30)..."; \
			sleep 10; \
		fi; \
		if [ $$i -eq 30 ]; then \
			echo "âŒ Timeout esperando RabbitMQ"; \
			exit 1; \
		fi; \
	done

create-rabbitmq-resources: wait-for-rabbitmq ## Crear exchanges, queues y bindings necesarios para replicaciÃ³n
	@echo "ğŸ° Creando recursos de RabbitMQ necesarios para replicaciÃ³n..."
	@echo ""
	
	@echo "ğŸ”¹ Obteniendo credenciales de RabbitMQ..."
	@RABBITMQ_PASSWORD=$$(kubectl get secret --namespace mediorder rabbitmq -o jsonpath="{.data.rabbitmq-password}" | base64 -d); \
	echo "ğŸ”¹ Creando exchange 'events'..."; \
	kubectl exec -n mediorder rabbitmq-0 -- rabbitmqadmin \
		--host=localhost \
		--port=15672 \
		--username=user \
		--password=$$RABBITMQ_PASSWORD \
		declare exchange \
		name=events \
		type=topic \
		durable=true || echo "âš ï¸  Exchange 'events' ya existe o error al crear"; \
	\
	echo "ğŸ”¹ Creando queue 'order-damage-queue'..."; \
	kubectl exec -n mediorder rabbitmq-0 -- rabbitmqadmin \
		--host=localhost \
		--port=15672 \
		--username=user \
		--password=$$RABBITMQ_PASSWORD \
		declare queue \
		name=order-damage-queue \
		durable=true || echo "âš ï¸  Queue 'order-damage-queue' ya existe o error al crear"; \
	\
	echo "ğŸ”¹ Creando queue 'order-events-queue'..."; \
	kubectl exec -n mediorder rabbitmq-0 -- rabbitmqadmin \
		--host=localhost \
		--port=15672 \
		--username=user \
		--password=$$RABBITMQ_PASSWORD \
		declare queue \
		name=order-events-queue \
		durable=true || echo "âš ï¸  Queue 'order-events-queue' ya existe o error al crear"; \
	\
	echo "ğŸ”¹ Creando binding 'order-damage-queue' â†’ 'events' exchange..."; \
	kubectl exec -n mediorder rabbitmq-0 -- rabbitmqadmin \
		--host=localhost \
		--port=15672 \
		--username=user \
		--password=$$RABBITMQ_PASSWORD \
		declare binding \
		source=events \
		destination=order-damage-queue \
		routing_key=order.damage || echo "âš ï¸  Binding ya existe o error al crear"; \
	\
	echo "ğŸ”¹ Creando binding 'order-events-queue' â†’ 'events' exchange..."; \
	kubectl exec -n mediorder rabbitmq-0 -- rabbitmqadmin \
		--host=localhost \
		--port=15672 \
		--username=user \
		--password=$$RABBITMQ_PASSWORD \
		declare binding \
		source=events \
		destination=order-events-queue \
		routing_key=order.events || echo "âš ï¸  Binding ya existe o error al crear"; \
	\
	echo ""; \
	echo "âœ… Recursos de RabbitMQ creados exitosamente!"; \
	echo "ğŸ“‹ Recursos creados:"; \
	echo "  ğŸ”¸ Exchange: events (topic)"; \
	echo "  ğŸ”¸ Queues:"; \
	echo "    â€¢ order-damage-queue (durable)"; \
	echo "    â€¢ order-events-queue (durable)"; \
	echo "  ğŸ”¸ Bindings:"; \
	echo "    â€¢ order-damage-queue â† events [order.damage]"
